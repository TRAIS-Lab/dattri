name: GPU Test on Comment

on:
  issue_comment:
    types: [created]

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  trigger-gpu-test:

    if: |
      github.event.issue.pull_request &&
      contains(github.event.comment.body, 'run gpu test')
    runs-on: ubuntu-latest
    
    steps:
      - name: Acknowledge trigger
        uses: actions/github-script@v7
        with:
          script: |
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `GPU test triggered by @${context.payload.comment.user.login}. Running tests...`
            });

      - name: Checkout PR code
        uses: actions/checkout@v4
        with:
          ref: refs/pull/${{ github.event.issue.number }}/head

      - name: Setup environment
        run: |
          pip uninstall -y dattri
          python -m pip install --upgrade pip
          pip install -e .[test]
      - name: Analysing the code with pytest
        run: |
          pytest -v -m gpu test
      - name: Uninstall the package
        run: |
          pip uninstall -y dattri
      - name: Cleanup build artifacts
        run: |
          rm -rf *.egg-info

      - name: Comment results
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const status = '${{ job.status }}';
            const message = status === 'success' 
              ? 'GPU tests passed.' 
              : 'GPU tests failed. Please check the logs.';
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: `${message}\n\n[View workflow run](${context.payload.repository.html_url}/actions/runs/${context.runId})`
            });